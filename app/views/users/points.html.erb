<! -- Page which allows administrators/officers to assign points to several users with an associated point source -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<h1>Assign Points to Members</h1>
<%= link_to("Go back to landing page", admin_dashboard_url)%>
<h3>Member List:</h3>

<!-- search bar -->
<div>
  <%= label_tag "search", "Search:" %>
  <%= text_field_tag "search", nil, id: "search_bar" %>
</div>

<%= form_tag handle_points_path, method: :post do %>
<table id="member_table">
    <! -- list of non-admin users with checkbox to select each one -->
    <% @users.each do |user| %>
        <tr>
            <td><%= user.name %>, (<%=user.points %> points)</td>
            <td><%= check_box_tag "selected_users[]", user.id %></td>
        </tr>
    <% end %>
</table>
<br />
<hr>
<br />
<! --assigned point amount -->
<div>
    <%= label_tag "new_points", "Points:" %>
    <%= number_field_tag "new_points", nil %>
</div>
<br />

<hr>
<br />
<! -- associated activity with the point assignment -->
<div>
    <%= label_tag "activity", "Associated Recurring Activity:" %>
    <%=
        select_tag "recur_activity_id",
        options_for_select(
            [["", nil]] + Activity.order(:name).map { |activity| [activity.name, activity.id] } + [["Custom One-Time Activity\u2026", nil]]
        ),
        id: "activity_select_box"
    %>
</div>
<div id="onetime_activity_section" class="hidden" style="margin-top: 1em;">
    <%= label_tag "activity", "Associated One-Time Activity:" %>
    <%= text_field_tag "onetime_activity_string" %>
</div>
<br />
<hr>
<br />
<%= submit_tag "Submit" %>
<script>

    // JavaScript for custom activity selection
    const actSelect = document.getElementById("activity_select_box");
    const actCustom = document.getElementById("onetime_activity_section");
    const actCustomInput = document.getElementById("onetime_activity_string");

    actSelect.addEventListener("change", event => {
        if (event.target.selectedOptions[0]?.text == "Custom One-Time Activity\u2026") {
            actCustom.classList.remove("hidden");
        }
        else {
            actCustom.classList.add("hidden");
            actCustomInput.value = "";
        }
    });

    // JavaScript for filtering members based on the search bar
    const searchInput = document.getElementById("search_bar");
    const memberTable = document.getElementById("member_table");

    searchInput.addEventListener("input", () => {
      const searchQuery = searchInput.value.toLowerCase();
      const rows = memberTable.querySelectorAll("tr");

      rows.forEach(row => {
        const userName = row.querySelector("td:first-child").textContent.toLowerCase();
        const isVisible = userName.includes(searchQuery);
        row.style.display = isVisible ? "table-row" : "none";
      });
    });

</script>
<% end %>
